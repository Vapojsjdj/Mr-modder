<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراقبة دردشة يوتيوب المباشرة | YouTube Live Chat Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="container">
        <header>
            <h2>
                <span class="en-text">Live Chat Download</span>
                <span class="ar-text">تحميل من الدردشة المباشرة</span>
            </h2>
        </header>
        
        <div id="initial-download-container" class="initial-download-container">
            <a href="#" class="download-button main-download-btn" id="main-download-btn">
                <span class="en-text"><i class="fas fa-download"></i> Download File</span>
                <span class="ar-text"><i class="fas fa-download"></i> تحميل الملف</span>
            </a>
        </div>
        
        <div id="verification-container" class="verification-container" style="display: none;">
            <div class="conditions-container" id="conditions-container">
                <div class="small-conditions-text">
                    <span class="en-text">Subscribe and type the password to unlock download.</span>
                    <span class="ar-text">اشترك واكتب كلمة المرور لفتح التحميل.</span>
                </div>
                <img src="https://s6.ezgif.com/tmp/ezgif-6cff9ab5db4de9.gif" alt="Download Conditions" class="conditions-image">
            </div>
            
            <div class="verification-steps">
                <div class="step">
                    <span class="step-number">1</span>
                    <div class="step-content">
                        <span class="en-text">Subscribe to the YouTube channel</span>
                        <span class="ar-text">اشترك في قناة اليوتيوب</span>
                    </div>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <div class="step-content">
                        <span class="en-text">Open the YouTube chat</span>
                        <span class="ar-text">افتح دردشة اليوتيوب</span>
                    </div>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <div class="step-content">
                        <span class="en-text">Type the password in chat</span>
                        <span class="ar-text">اكتب كلمة المرور في الدردشة</span>
                    </div>
                </div>
                <div class="step">
                    <span class="step-number">4</span>
                    <div class="step-content">
                        <span class="en-text">Download will be available automatically</span>
                        <span class="ar-text">سيكون التحميل متاحًا تلقائيًا</span>
                    </div>
                </div>
            </div>
            
            <div class="subscribe-button-container">
                <a href="https://youtube.com/@mrmoder99?si=obSOK2daytB8aozg" target="_blank" id="subscribe-button" class="subscribe-button">
                    <span class="en-text"><i class="fab fa-youtube"></i> Subscribe to Channel</span>
                    <span class="ar-text"><i class="fab fa-youtube"></i> اشترك في القناة</span>
                </a>
            </div>
            
            <div class="chat-button-container">
                <a href="https://www.youtube.com/live/KbH9d0PwEdA?si=IegaYoKyBWZ3b9lR" target="_blank" id="chat-button" class="chat-button">
                    <span class="en-text"><i class="fab fa-youtube"></i> Open YouTube Chat</span>
                    <span class="ar-text"><i class="fab fa-youtube"></i> فتح دردشة يوتيوب</span>
                </a>
            </div>
            
            <div class="monitoring-controls">
                <div class="keyword-container">
                    <div>
                        <span class="en-text">Password to type in chat:</span>
                        <span class="ar-text">كلمة المرور المطلوب كتابتها في الدردشة:</span>
                    </div>
                    <div class="keyword-display" id="keyword-display">جاري التحميل...</div>
                    <div class="keyword-buttons">
                        <button class="copy-keyword" id="copy-keyword">
                            <span class="en-text"><i class="fas fa-copy"></i> Copy Word</span>
                            <span class="ar-text"><i class="fas fa-copy"></i> نسخ الكلمة</span>
                        </button>
                        <button class="check-chat-button" id="check-chat-button">
                            <span class="en-text"><i class="fas fa-search"></i> Check Chat</span>
                            <span class="ar-text"><i class="fas fa-search"></i> تحقق من الدردشة</span>
                        </button>
                    </div>
                </div>
                
                <div class="status-container">
                    <div id="status-message">
                        <span class="en-text">Ready to check chat...</span>
                        <span class="ar-text">جاهز للتحقق من الدردشة...</span>
                    </div>
                    <div class="loader" id="loader" style="display: none;"></div>
                </div>
            </div>
            
            <div id="download-container" class="download-container download-incomplete">
                <div id="download-warning" class="warning-message">
                    <span class="en-text"><i class="fas fa-exclamation-triangle"></i> Please complete the conditions to download</span>
                    <span class="ar-text"><i class="fas fa-exclamation-triangle"></i> يرجى إكمال الشروط للتحميل</span>
                </div>
                
                <div class="file-info">
                    <div class="file-icon">ZIP</div>
                    <div class="file-details">
                        <div class="file-name" id="file-name">YourAwesomeFile.zip</div>
                        <div class="file-size" id="file-size">15.3 MB</div>
                    </div>
                </div>
                
                <div class="download-progress">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                
                <div id="download-button-container" style="display: none;">
                    <a href="#" class="download-button disabled" id="download-link">
                        <span class="en-text"><i class="fas fa-download"></i> Download File</span>
                        <span class="ar-text"><i class="fas fa-download"></i> تحميل الملف</span>
                    </a>
                    
                    <div class="file-secure">
                        <div class="secure-icon"><i class="fas fa-shield-alt"></i></div>
                        <div>
                            <span class="en-text">Secure Download</span>
                            <span class="ar-text">تحميل آمن</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="not-found-message" class="not-found-message" style="display: none;">
                <span class="en-text">Not found</span>
                <span class="ar-text">لا يوجد</span>
            </div>
            
            <div class="chat-container" style="display: none;">
                <ul id="chat-messages"></ul>
            </div>
        </div>
    </div>

    <script type="module">
    import { config } from './config.js';
    import { YouTubeChatMonitor } from './chat-monitor.js';
    import { ChatUtils } from './utils.js';
    import { ChatUtilities } from './chat-utilities.js';
    import { DownloadHandler } from './download-handler.js';
    
    document.addEventListener('DOMContentLoaded', () => {
        // Set file information from config
        document.getElementById('file-name').textContent = config.FILE_NAME;
        document.getElementById('file-size').textContent = config.FILE_SIZE;
        
        // Initialize download handler
        const downloadHandler = new DownloadHandler();
        window.downloadHandler = downloadHandler; // Make it available globally
        
        // Adjust page content to avoid scrolling
        adjustPageLayout();

        let chatMonitorInstance = null; // Declare a variable to hold the chat monitor instance
        
        // Initial download button click handler
        document.getElementById('main-download-btn').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('initial-download-container').style.display = 'none';
            document.getElementById('verification-container').style.display = 'block';
            
            // Initialize the monitor without auto-starting
            if (!chatMonitorInstance) {
                chatMonitorInstance = new YouTubeChatMonitor();
                window.chatMonitor = chatMonitorInstance; // Make it available if needed
            }

            // Set initial status message
            ChatUtils.updateBilingualElement(
                document.getElementById('status-message'),
                config.TRANSLATIONS.readyToMonitor.en,
                config.TRANSLATIONS.readyToMonitor.ar
            );
            document.getElementById('loader').style.display = 'none'; // Ensure loader is hidden initially
        });

        // Add event listener for the new check chat button
        document.getElementById('check-chat-button').addEventListener('click', function() {
            if (chatMonitorInstance) {
                // Disable the button to prevent multiple clicks
                this.disabled = true;
                // Start monitoring
                chatMonitorInstance.startMonitoring();
                // Optionally change button text or show progress
                ChatUtils.updateBilingualElement(this, 
                    '<i class="fas fa-spinner fa-spin"></i> Checking...', 
                    '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...');
            }
        });
        
        // Copy keyword button
        document.getElementById('copy-keyword').addEventListener('click', function() {
            const keyword = document.getElementById('keyword-display').textContent;
            navigator.clipboard.writeText(keyword).then(() => {
                // Show copied notification
                const oldText = this.innerHTML;
                
                ChatUtils.updateBilingualElement(this, 
                    '<i class="fas fa-check"></i> Copied!', 
                    '<i class="fas fa-check"></i> تم النسخ!');
                    
                setTimeout(() => {
                    this.innerHTML = oldText;
                }, 2000);
            });
        });

        // Subscribe button click handler
        document.getElementById('subscribe-button').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show subscription verification progress
            const subscribeStep = document.querySelector('.step:nth-child(1)');
            const subscriptionProgress = document.createElement('div');
            subscriptionProgress.className = 'subscription-progress';
            subscriptionProgress.innerHTML = '<div class="subscription-bar"></div>';
            subscribeStep.appendChild(subscriptionProgress);
            
            subscriptionProgress.style.display = 'block';
            
            // Start progress animation
            setTimeout(() => {
                subscriptionProgress.querySelector('.subscription-bar').style.width = '100%';
            }, 100);
            
            // Simulate verification completion after 3 seconds
            setTimeout(() => {
                // Mark step as completed
                subscribeStep.classList.add('completed');
                
                // Add checkmark to the step
                const checkmark = document.createElement('span');
                checkmark.className = 'step-checkmark';
                checkmark.innerHTML = '<i class="fas fa-check-circle"></i>';
                subscribeStep.appendChild(checkmark);
                
                // Remove progress bar
                setTimeout(() => {
                    subscriptionProgress.style.display = 'none';
                    
                    // Show chat button
                    document.querySelector('.chat-button-container').style.display = 'block';
                    
                    // Show toast notification
                    ChatUtilities.showToast('Subscription verified successfully!');
                }, 500);
            }, 3000);
            
            // Open YouTube channel in new tab
            window.open(this.href, '_blank');
        });
        
        // Chat button click handler
        document.getElementById('chat-button').addEventListener('click', function() {
            // Mark chat step as completed
            const chatStep = document.querySelector('.step:nth-child(2)');
            chatStep.classList.add('completed');
            
            // Add checkmark to the step
            const checkmark = document.createElement('span');
            checkmark.className = 'step-checkmark';
            checkmark.innerHTML = '<i class="fas fa-check-circle"></i>';
            chatStep.appendChild(checkmark);
        });
        
        // Function to adjust page layout
        function adjustPageLayout() {
            // Reduce padding and margins to make content fit without scrolling
            const container = document.querySelector('.container');
            if (window.innerHeight < 800) {
                container.style.padding = '10px';
                container.style.marginTop = '10px';
                container.style.marginBottom = '10px';
            }
            
            // Limit chat container height
            // This is no longer necessary as chat container is hidden, but keeping the function for other potential layout adjustments.
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                chatContainer.style.maxHeight = '200px';
            }
        }
    });
    </script>
    
    <script>
        let audioContext;
        let audioBuffer;
        let sourceNode;

        const startAudio = async () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Check if context is suspended and try to resume
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            if (!audioBuffer) {
                try {
                    const response = await fetch('ElevenLabs_2025-08-01T10_01_13_Liam_pre_sp100_s50_sb75_v3.mp3');
                    const arrayBuffer = await response.arrayBuffer();
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                } catch (error) {
                    console.error('Error loading or decoding audio:', error);
                    return;
                }
            }

            if (sourceNode && sourceNode.buffer) {
                // If sourceNode already exists and has a buffer, it means audio is playing or was prepared.
                // We prevent creating duplicates if user clicks multiple times.
                // We should stop current source and restart for seamless loop if needed,
                // but for "play on first interaction" and looping, we only start once.
                return; 
            }

            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.loop = true; // Loop the audio
            sourceNode.connect(audioContext.destination);
            sourceNode.start(0); // Play immediately
            console.log('Audio started.');
        };

        // Event listener to start audio on first user interaction
        document.body.addEventListener('click', startAudio, { once: true });
        document.body.addEventListener('touchstart', startAudio, { once: true });

        // Optional: Preload audio, but don't play until interaction
        document.addEventListener('DOMContentLoaded', () => {
            // Initiate audio context and buffer loading early
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            fetch('ElevenLabs_2025-08-01T10_01_13_Liam_pre_sp100_s50_sb75_v3.mp3')
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(buffer => {
                    audioBuffer = buffer;
                    console.log('Audio preloaded.');
                })
                .catch(error => console.error('Error preloading audio:', error));
        });
    </script>

</body>
</html>